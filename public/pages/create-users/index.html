<!DOCTYPE html>
<html lang="pt-BR">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>CRUD Perfil Master</title>
		<link rel="stylesheet" href="/styles/output.css" />
	</head>
	<body class="bg-primary">
		<header class="w-full flex items-center p-2">
			<img src="/assets/images/logo-h-whitebg.svg" />
		</header>

		<div class="max-w-4xl mx-auto bg-tertiary p-6 rounded-lg shadow-lg">
			<h2 id="titulo-cadastro" class="text-3xl font-semibold text-gray-800 mb-6 text-center">Crud Master</h2>
			<form id="form-cadastro" class="space-y-4">
				<div class="flex flex-col gap-8 p-10">
					<!-- Campos Nome, Sobrenome, Email, etc. -->
					<div class="flex flex-col gap-2">
						<label for="nome" class="font-medium inline-block">Nome <span class="text-error">*</span></label>
						<input id="nome" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite seu nome" />
						<span id="erro-nome" class="text-xs text-red-500 hidden">Nome inválido</span>
					</div>

					<div class="flex flex-col gap-2">
						<label for="sobrenome" class="font-medium">Sobrenome <span class="text-error">*</span></label>
						<input id="sobrenome" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite seu sobrenome" />
						<span id="erro-sobrenome" class="text-xs text-red-500 hidden">Sobrenome inválido</span>
					</div>

					<div class="flex flex-col gap-2">
						<label for="email" class="font-medium">E-mail <span class="text-error">*</span></label>
						<input id="email" type="email" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite seu e-mail" />
						<span id="erro-email" class="text-xs text-red-500 hidden">E-mail inválido</span>
					</div>

					<div class="flex flex-col gap-2">
						<label for="senha" class="font-medium">Senha <span class="text-error">*</span></label>
						<input id="senha" type="password" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite sua senha" />
						<span id="erro-senha" class="text-xs text-red-500 hidden">Senha inválida</span>
					</div>

					<div class="flex flex-col gap-2">
						<label for="telefone" class="font-medium">Telefone <span class="text-error">*</span></label>
						<input id="telefone" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite seu telefone" />
						<span id="erro-telefone" class="text-xs text-red-500 hidden">Telefone inválido</span>
					</div>

					<div class="flex flex-col gap-2">
						<label for="cpf" class="font-medium">CPF <span class="text-error">*</span></label>
						<input id="cpf" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite seu CPF" />
						<span id="erro-cpf" class="text-xs text-red-500 hidden">CPF inválido</span>
					</div>

					<div class="flex flex-col gap-2">
						<label for="dataNascimento" class="font-medium">Data de Nascimento <span class="text-error">*</span></label>
						<input id="dataNascimento" type="date" class="rounded-md p-3 text-sm border border-secondary" />
						<span id="erro-dataNascimento" class="text-xs text-red-500 hidden">Data de nascimento inválida</span>
					</div>

					<div class="flex flex-col gap-2">
						<label for="tipoUsuario" class="font-medium">Tipo de Usuário <span class="text-error">*</span></label>
						<select id="tipoUsuario" class="rounded-md p-3 text-sm border border-secondary">
							<option value="">Selecione</option>
							<option value="Gerente">Gerente</option>
							<option value="Treinador">Treinador</option>
							<option value="Tratador">Tratador</option>
							<option value="Veterinario">Veterinário</option>
						</select>
						<span id="erro-tipoUsuario" class="text-xs text-red-500 hidden">Selecione um tipo de usuário</span>
					</div>

					<!-- NOVO CAMPO (já estava no GitHub, vamos usar corretamente agora) -->
					<div id="container-haras" class="hidden flex flex-col gap-2">
						<label for="select-haras" class="font-medium">Selecione o Haras <span class="text-error">*</span></label>
						<select id="select-haras" class="rounded-md p-3 text-sm border border-secondary">
							<option value="">Selecione o Haras</option>
						</select>
						<span id="erro-haras" class="text-xs text-red-500 hidden">Selecione um Haras</span>
					</div>

					<!-- Campos CRMV só para Veterinário -->
					<div id="campo-crmv" class="hidden flex flex-col gap-2">
						<label for="crmv" class="font-medium">CRMV</label>
						<input id="crmv" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite o CRMV" />
						<span id="erro-crmv" class="text-xs text-red-500 hidden">CRMV inválido</span>
					</div>

					<button id="botao-cadastrar-user" class="bg-secondary text-tertiary p-3 rounded-md hover:bg-primary transition-all">Cadastrar</button>
				</div>
			</form>
		</div>

		<script>
		/* ---------------------- CONSTANTES / ELEMENTOS FIXOS ---------------------- */
		const TOKEN          = localStorage.getItem("token");

		const form           = document.getElementById("form-cadastro");

		const tipoSelect     = document.getElementById("tipoUsuario");
		const crmvBox        = document.getElementById("campo-crmv");
		const crmvField      = document.getElementById("crmv");

		const harasBox       = document.getElementById("container-haras");
		const selectHaras    = document.getElementById("select-haras");

		/* ---------------------- MOSTRA / ESCONDE CAMPOS EXTRA --------------------- */
		tipoSelect.addEventListener("change", () => {
			if (tipoSelect.value === "Veterinario") {
			crmvBox.classList.remove("hidden");
			harasBox.classList.add("hidden");
			} else if (tipoSelect.value === "Gerente") {
			crmvBox.classList.add("hidden");
			harasBox.classList.remove("hidden");
			carregarHaras();
			} else {
			crmvBox.classList.add("hidden");
			harasBox.classList.add("hidden");
			}
		});

		async function carregarHaras() {
			try {
			const r = await fetch("http://localhost:3000/api/getAllHaras", {
				headers: { Authorization: `Bearer ${TOKEN}` }
			});
			if (!r.ok) throw new Error("Erro ao buscar Haras");
			const lista = await r.json();

			selectHaras.innerHTML =
				'<option value="">Selecione o Haras</option>' +
				lista.map(h => `<option value="${h.id}">${h.Nome}</option>`).join("");
			} catch (e) {
			console.error(e.message);
			}
		}

		/* ----------------------------- VALIDAÇÕES --------------------------------- */
		function mostrarErro(id)  { document.getElementById(id).classList.remove("hidden"); }
		function esconderErro(id) { document.getElementById(id).classList.add("hidden"); }

		function validarNome(v)        { return v.length >= 2; }
		function validarSobrenome(v)   { return v.length >= 2; }
		function validarEmail(v)       { return /^[\w-.]+@([\w-]+\.)+[\w-]{2,4}$/.test(v); }
		function validarSenha(v)       { return v.length >= 6 && v.length <= 20; }
		function validarTelefone(v)    { return /^\d{10,11}$/.test(v); }
		function validarCPF(v)         { return /^\d{11}$/.test(v); }
		function validarData(v)        { return !!v; }
		function validarCRMV(v)        { return /^\w{3,20}$/.test(v); }

		/* ------------------------- SUBMIT COM VALIDAÇÃO --------------------------- */
		form.addEventListener("submit", async (ev) => {

			/* campos */
			const nomeField   = document.getElementById("nome");
			const sobreField  = document.getElementById("sobrenome");
			const emailField  = document.getElementById("email");
			const senhaField  = document.getElementById("senha");
			const telField    = document.getElementById("telefone");
			const cpfField    = document.getElementById("cpf");
			const dataField   = document.getElementById("dataNascimento");

			/* --- valida ---- */
			let ok = true;

			if (!validarNome(nomeField.value.trim()))                       { mostrarErro("erro-nome");           ok = false; } else esconderErro("erro-nome");
			if (!validarSobrenome(sobreField.value.trim()))                 { mostrarErro("erro-sobrenome");      ok = false; } else esconderErro("erro-sobrenome");
			if (!validarEmail(emailField.value.trim()))                     { mostrarErro("erro-email");          ok = false; } else esconderErro("erro-email");
			if (!validarSenha(senhaField.value.trim()))                     { mostrarErro("erro-senha");          ok = false; } else esconderErro("erro-senha");
			if (!validarTelefone(telField.value.replace(/\D/g,"")))         { mostrarErro("erro-telefone");       ok = false; } else esconderErro("erro-telefone");
			if (!validarCPF(cpfField.value.replace(/\D/g,"")))              { mostrarErro("erro-cpf");            ok = false; } else esconderErro("erro-cpf");
			if (!validarData(dataField.value))                              { mostrarErro("erro-dataNascimento"); ok = false; } else esconderErro("erro-dataNascimento");
			if (!tipoSelect.value)                                          { mostrarErro("erro-tipoUsuario");    ok = false; } else esconderErro("erro-tipoUsuario");

			if (tipoSelect.value === "Veterinario") {
			if (!validarCRMV(crmvField.value.trim()))                     { mostrarErro("erro-crmv");           ok = false; } else esconderErro("erro-crmv");
			}

			if (tipoSelect.value === "Gerente") {
			if (!selectHaras.value)                                       { mostrarErro("erro-haras");          ok = false; } else esconderErro("erro-haras");
			}

			if (!ok) { ev.preventDefault(); return; }   // bloqueia envio se houver erro
			ev.preventDefault();                        // evita recarregar a página

			/* --- monta body / endpoint ---- */
			const body = {
			nome           : nomeField.value.trim(),
			sobrenome      : sobreField.value.trim(),
			email          : emailField.value.trim(),
			senha          : senhaField.value.trim(),
			telefone       : telField.value.trim(),
			cpf            : cpfField.value.replace(/\D/g,""),
			dataNascimento : dataField.value.trim()
			};

			let endpoint = "";
			if (tipoSelect.value === "Gerente") {
			endpoint = "criarGerente";
			body.haras_id = selectHaras.value;
			}
			else if (tipoSelect.value === "Treinador") endpoint = "criarTreinador";
			else if (tipoSelect.value === "Tratador")  endpoint = "criarTratador";
			else if (tipoSelect.value === "Veterinario") {
			endpoint  = "criarVeterinario";
			body.crmv = crmvField.value.trim();
			}

			/* --- envia ---- */
			try {
			const r = await fetch(`http://localhost:3000/api/${endpoint}`, {
				method : "POST",
				headers: { "Content-Type": "application/json", Authorization: `Bearer ${TOKEN}` },
				body   : JSON.stringify(body)
			});
			const res = await r.json();
			if (!r.ok) throw new Error(res.error || "Erro ao cadastrar");

			alert(`${tipoSelect.value} cadastrado com sucesso!`);
			location.reload();
			} catch (e) {
			alert("Falha: " + e.message);
			}
		});
		</script>
	</body>
</html>
