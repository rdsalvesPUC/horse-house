<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Novo Cavalo</title>
    <link rel="stylesheet" href="/styles/output.css"/>
</head>
<body class="bg-primary">
<header class="w-full flex items-center p-2">
    <img src="/assets/images/logo-h-whitebg.svg"/>
</header>

<div class="max-w-4xl mx-auto bg-tertiary p-6 rounded-lg shadow-lg">
    <h2 id="titulo-cadastro" class="text-3xl font-semibold text-gray-800 mb-6 text-center">Novo Cavalo</h2>
    <form id="form-cadastro" class="space-y-4">
        <div class="flex flex-col gap-8 p-10">
            <!-- Campos Nome, Sobrenome, Email, etc. -->
            <!-- NOME -->
            <div class="flex flex-col gap-2">
                <label for="nome" class="font-medium">Nome<span class="text-error"> *</span></label>
                <input id="nome" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite o nome do cavalo"/>
                <p id="nome-erro" class="text-error text-sm mt-1 hidden">O Nome é obrigatório.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for="peso" class="font-medium">Peso<span class="text-error"> *</span></label>
                <input id="peso" type="number" step="0.01" class="rounded-md p-3 text-sm border border-secondary" placeholder="Digite o peso do cavalo"/>
                <p id="peso-erro" class="text-error text-sm mt-1 hidden">O Peso é obrigatório.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for="sexo" class="font-medium">Sexo<span class="text-error"> *</span></label>
                <select id="sexo" class="rounded-md p-3 text-sm border border-secondary">
                    <option value="">Selecione o sexo</option>
                    <option value="macho">Macho</option>
                    <option value="femea">Fêmea</option>
                </select>
                <p id="sexo-erro" class="text-error text-sm mt-1 hidden">O Sexo é obrigatório.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for="importado" class="font-medium">Importado<span class="text-error"> *</span></label>
                <select id="importado" class="rounded-md p-3 text-sm border border-secondary">
                    <option value="">O cavalo é importado?</option>
                    <option value="1">Sim</option>
                    <option value="0">Não</option>
                </select>
                <p id="importado-erro" class="text-error text-sm mt-1 hidden">O status de importação é Obrigatório.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for="pelagem" class="font-medium">Pelagem<span class="text-error"> *</span></label>
                <input id="pelagem" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Insira a pelagem do cavalo"/>
                <p id="pelagem-erro" class="text-error text-sm mt-1 hidden">A pelagem é obrigatória.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for="sangue" class="font-medium">Tipo Sanguíneo<span class="text-error"> *</span></label>
                <select id="sangue" class="rounded-md p-3 text-sm border border-secondary">
                    <option value="">Selecione o tipo sanguíneo do cavalo</option>
                    <option value="A">A</option>
                    <option value="C">C</option>
                    <option value="D">D</option>
                    <option value="K">K</option>
                    <option value="P">P</option>
                    <option value="Q">Q</option>
                    <option value="U">U</option>
                </select>
                <p id="sangue-erro" class="text-error text-sm mt-1 hidden">O Tipo Sanguíneo é obrigatório.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for="registro" class="font-medium">Registro<span class="text-error"> *</span></label>
                <input id="registro" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Insira o número de registro do cavalo"/>
                <p id="registro-erro" class="text-error text-sm mt-1 hidden">O registro é obrigatório.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for = "cert" class="font-medium">Cert<span class="text-error"> *</span></label>
                <input id="cert" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Insira o número do Cert do cavalo"/>
                <p id="cert-erro" class="text-error text-sm mt-1 hidden">O Cert é obrigatório.</p>
            </div>

            <!-- DATA DE NASCIMENTO -->
            <div class="flex flex-col gap-2">
                <label for="dataNascimento" class="font-medium">Data de Nascimento<span class="text-error"> *</span></label>
                <input id="dataNascimento" type="date" class="rounded-md p-3 text-sm border border-secondary"/>
                <p id="data-nascimento-erro" class="text-error text-sm mt-1 hidden">A Data de Nascimento é obrigatória.</p>
                <p id="data-nascimento-invalida" class="text-error text-sm mt-1 hidden">Insira uma data de nascimento válida.</p>
            </div>

            <div class="flex flex-col gap-2">
                <label for="situacao" class="font-medium">Situação<span class="text-error"> *</span></label>
                <input id="situacao" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Insira a situação do cavalo"/>
                <p id="situacao-erro" class="text-error text-sm mt-1 hidden">A situação é obrigatória.</p>
            </div>
            <div class="flex flex-col gap-2">
                <label for="status" class="font-medium">Status<span class="text-error"> *</span></label>
                <input id="status" type="text" class="rounded-md p-3 text-sm border border-secondary" placeholder="Insira o status do cavalo"/>
                <p id="status-erro" class="text-error text-sm mt-1 hidden">O status é obrigatório.</p>
            </div>

            <!-- NOVO CAMPO (já estava no GitHub, vamos usar corretamente agora) -->
            <div id="container-haras" class="flex flex-col gap-2">
                <label for="select-haras" class="font-medium">Selecione o Haras</label>
                <select id="select-haras" class="rounded-md p-3 text-sm border border-secondary">
                    <option value="">Selecione o Haras</option>
                </select>
                <span id="erro-haras" class="text-xs text-red-500 hidden">Selecione um Haras</span>
            </div>

            <button type="submit" class="bg-secondary text-tertiary p-3 rounded-md hover:bg-primary transition-all">Cadastrar</button>
        </div>
    </form>
</div>

<script type="module">
    import Modal from "/scripts/load-modal.js";

    const modal = new Modal();

    const TOKEN = localStorage.getItem("token");

    const containerHaras = document.getElementById("container-haras");
    const selectHaras = document.getElementById("select-haras");

    async function acessoControle() {
        const TOKEN = localStorage.getItem("token");
        const r = await fetch("/api/requerProprietario", {
            headers: {Authorization: `Bearer ${TOKEN}`},
        });
        if (!r.ok) {
            const result = await r.json();
            window.location.href = result.login ? "/login" : "/home";
        }
        const res = await r.json()

    }

    acessoControle();
    carregarHaras()
    async function carregarHaras() {
        try {
            const response = await fetch("/api/getAllHaras", {
                method: "GET",
                headers: {
                    Authorization: `Bearer ${localStorage.getItem("token")}`,
                    "Content-Type": "application/json",
                },
            });

            if (!response.ok) {
                throw new Error("Erro ao buscar haras");
            }

            const haras = await response.json();

            // Limpa e popula o select
            selectHaras.innerHTML = '<option value="">Selecione o Haras</option>';
            haras.forEach((harasItem) => {
                const option = document.createElement("option");
                option.value = harasItem.ID // aqui precisa ser o id do haras
                option.textContent = harasItem.Nome;
                selectHaras.appendChild(option);
            });
        } catch (error) {
            console.error("Erro ao carregar haras:", error.message);
        }
    }

    document.getElementById("form-cadastro").addEventListener("submit", async function (event) {
        event.preventDefault();

        const nome = document.getElementById("nome").value.trim();
        const peso = document.getElementById("peso").value.trim();
        const sexo = document.getElementById("sexo").value.trim();
        const importado = document.getElementById("importado").value.trim();
        const pelagem = document.getElementById("pelagem").value.trim();
        const sangue = document.getElementById("sangue").value.trim();
        const registro = document.getElementById("registro").value.trim();
        const cert = document.getElementById("cert").value.trim();
        const dataNascimento = document.getElementById("dataNascimento").value.trim();
        const harasId = selectHaras.value;

        let valido = true;

        if (!nome) {
            document.getElementById("nome-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("nome-erro").classList.add("hidden");
        }
        if (!peso) {
            document.getElementById("peso-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("peso-erro").classList.add("hidden");
        }
        if (!sexo) {
            document.getElementById("sexo-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("sexo-erro").classList.add("hidden");
        }
        if (!importado) {
            document.getElementById("importado-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("importado-erro").classList.add("hidden");
        }
        if (!pelagem) {
            document.getElementById("pelagem-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("pelagem-erro").classList.add("hidden");
        }
        if (!sangue) {
            document.getElementById("sangue-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("sangue-erro").classList.add("hidden");
        }
        if (!registro) {
            document.getElementById("registro-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("registro-erro").classList.add("hidden");
        }
        if (!cert) {
            document.getElementById("cert-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("cert-erro").classList.add("hidden");
        }
        if (!dataNascimento) {
            document.getElementById("data-nascimento-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("data-nascimento-erro").classList.add("hidden");
        }
        if (dataNascimento && new Date(dataNascimento) > new Date()) {
            document.getElementById("data-nascimento-invalida").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("data-nascimento-invalida").classList.add("hidden");
        }
        if (!harasId) {
            document.getElementById("erro-haras").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("erro-haras").classList.add("hidden");
        }
        if (!situacao) {
            document.getElementById("situacao-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("situacao-erro").classList.add("hidden");
        }
        if (!status) {
            document.getElementById("status-erro").classList.remove("hidden");
            valido = false;
        } else {
            document.getElementById("status-erro").classList.add("hidden");
        }
        if (!valido) {
            return;
        }
        const dados = {
            nome,
            peso,
            sexo,
            imp: importado,
            pelagem,
            sangue,
            registro,
            situacao,
            status,
            cert,
            dataNascimento,
            harasId,
        }

        try {
            const response = await fetch(`/api/cavalos/criar`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    Authorization: `Bearer ${TOKEN}`,
                },
                body: JSON.stringify(dados),
            });
            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || "Erro ao cadastrar.");
            }

            await modal.show("Cavalo cadastrado com sucesso!");
            window.location.href = "/dashboard/cavalos";
        } catch (error) {
            await modal.show("Erro ao cadastrar: " + error.message);
        }
    });
</script>
</body>
</html>
